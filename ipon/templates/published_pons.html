<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>Published Pons</title>
    <link rel="icon" type="image/png" href="{% static 'assets/icon.png' %}">
    <link rel="stylesheet" href="{% static 'mained.css' %}">
</head>

<nav class="back-main"> 
    <div class="back-title" >Published Pons</div> 
</nav>

<body>
    {% comment %} <h1>Published Rides</h1> {% endcomment %}
    {% comment %} Tengo que hacer las tarjetas para esta secci√≥n :'D {% endcomment %}
    <div class="cards-container">
            {% if published_pons %}
                {% with all_finished=True %}
                    {% for ride in published_pons %}
                        {% if ride.Status != 'Finished' and ride.Status != 'Paid' %}
                            {% with all_finished=False %}
                                <div id="rides-container" class="pon-card">
                                    <div class="ride-card">
                                        <div style="display: flex; justify-content: space-between;">
                                        <h4>From / to</h4><h4>Pon # {{ ride.Ride_id }}</h4>
                                        </div>
                                        <hr><br>
                                        <p><b>Driver:</b> {% if ride.Driver.Username == 'temp_driver' %} Empty... {% else %} {{ ride.Driver.Username }} {% endif %}</p>
                                        <p><b>License:</b> {{ ride.Driver.License_plate }}</p>
                                        <p><b>Occupied:</b> {{ ride.Passenger.count }} / 4</p>
                                        <p><b>Passengers:</b> 
                                            {% for passenger in ride.Passenger.all %}
                                                {{ passenger.Username }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </p> <!-- Accessing the current passengers in the ride-->
                                        <p><b>From:</b> {{ ride.Start_location.name }}</p>  <!-- Accessing location name -->
                                        <p><b>To:</b> {{ ride.End_location.name }}</p>  <!-- Accessing location name -->
                                        <p><b>Current Status:</b> {{ ride.Status }}</p>
                                        <p><b>Start Date:</b> {{ ride.Date_Start }}</p>
                                        <p><b>End Date:</b> {{ ride.Date_End }}</p>
                                        <br>
                                        <button 
                                            id="route-btn" 
                                            class="brutalist-card__button brutalist-card__button--mark" 
                                            style="font-size: 2vh;"
                                            onclick="acceptPon('{{ ride.Ride_id }}')">
                                            Accept this Pon
                                        </button>
                                    </div>
                                </div>
                            {% endwith %}
                        {% endif %} 
                    {% endfor %}
                    {% if all_finished %}
                        <p style="font-size: 2.5vh;">No more published Pons available.</p>
                    {% endif %}
                {% endwith %}
            {% else %}
                <p style="font-size: 2.5vh;">No published Pons available.</p>
            {% endif %}
        

        {% comment %} //////////////////////// prueba //////////////////////// {% endcomment %}
        {% comment %} <div id="rides-container" class="pon-card"> {% endcomment %}
            {% comment %} {% if published_pons %}
                {% for ride in published_pons %}
                    <div class="ride-card">
                        <div style="display: flex; justify-content: space-between;">
                        <h4>From / to</h4><h4>Pon # {{ ride.Ride_id }}</h4>
                        </div>
                        <hr><br>
                        <p><b>Driver:</b> {{ ride.Driver.Username }}</p>  <!-- Ensure this matches your User model field -->
                        <p><b>License:</b> </p>
                        <p><b>Occupied:</b> 1 / 4</p>
                        <p><b>Passenger:</b> {{ ride.Passenger.Username }}</p>  <!-- Accessing passenger's username -->
                        <p><b>From:</b> {{ ride.Start_location.name }}</p>  <!-- Accessing location name -->
                        <p><b>To:</b> {{ ride.End_location.name }}</p>  <!-- Accessing location name -->
                        <p><b>Start Date:</b> {{ ride.Date_Start }}</p>
                        <p><b>End Date:</b> {{ ride.Date_End }}</p>
                        <br>
                        <button id="route-btn" class="brutalist-card__button brutalist-card__button--mark" style="font-size: 2vh;">Accept this Pon</button>
                    </div>
                {% endfor %}
            {% else %}
                <p>No published rides available.</p>
            {% endif %}
        </div> {% endcomment %}
        {% comment %} //////////////////////// prueba //////////////////////// {% endcomment %}

    </div>

    <nav class="back-main"> 
        <div class="back-title"><a href="{% url 'main' %}"><img src="{% static 'assets/iconos/back.png' %}">Back</a></div>
    </nav>
    

    <script>
        function acceptPon(ponId) {
            // Send the Pon ID to the server
            fetch("{% url 'accept_pon' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',  // Use JSON if preferred
                    'X-CSRFToken': '{{ csrf_token }}',  // CSRF token for protection
                },
                body: new URLSearchParams({ pon_id: ponId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);  // Notify the user
                    window.location.href = "{% url 'pon_status' %}"; // redirect to the user's added pon status
                } else {
                    alert(data.message);  // Notify the user of any errors
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while accepting the Pon.');
            });
        }

        var is_driver = {{ is_active|yesno:"true,false" }};
    </script>
    <script src="{% static 'jstemplates/color_change.js' %}"></script>
</body>
</html>

